<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo Visualization Widget - Infrastructure Monitor</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>
<body>
    <div id="app">
        <header class="app-header">
            <h1>Infrastructure Global Distribution</h1>
            <p class="subtitle">Datacenter & Resource Monitoring</p>
        </header>
        
        <div id="geo-map-container" class="geo-map-container">
            <!-- D3 map will be rendered here -->
        </div>
        
        <!-- Filter Controls -->
        <div class="filter-controls">
            <button class="view-toggle" id="viewToggle" aria-label="Toggle view">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
            </button>
            
            <div class="filter-group">
                <label for="regionFilter">Region</label>
                <select id="regionFilter" class="filter-select" aria-label="Filter by region">
                    <option value="All">All</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="locationFilter">Location</label>
                <select id="locationFilter" class="filter-select" aria-label="Filter by location">
                    <option value="All">All</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="datacentreFilter">Datacentre</label>
                <select id="datacentreFilter" class="filter-select" aria-label="Filter by datacentre">
                    <option value="All">All</option>
                </select>
            </div>
        </div>
        
        <!-- Selection Info Panel -->
        <div class="selection-info" id="selectionInfo" aria-live="polite">
            <span class="selection-count">0 selected</span>
            <button class="clear-selection" id="clearSelection" style="display: none;">Clear</button>
        </div>
        
        <!-- Interaction Guide -->
        <section class="interaction-guide" aria-labelledby="guide-title">
            <header class="guide-header">
                <h2 id="guide-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Interaction Guide
                </h2>
                <p class="guide-subtitle">Learn how to navigate and interact with the visualization</p>
            </header>
            
            <div class="interaction-cards">
                <!-- Single Click -->
                <article class="interaction-card">
                    <div class="card-icon click-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 9l6 6 6-6"></path>
                            <circle cx="12" cy="6" r="2"></circle>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3>Single Click</h3>
                        <ul>
                            <li>Selects or deselects a marker</li>
                            <li>Applies selected state styling (blue highlight)</li>
                            <li>Does <strong>not</strong> zoom the map</li>
                        </ul>
                    </div>
                </article>
                
                <!-- Double Click -->
                <article class="interaction-card">
                    <div class="card-icon double-click-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M8 12h8"></path>
                            <path d="M12 8v8"></path>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3>Double Click</h3>
                        <ul>
                            <li>Zooms to fit all children in view</li>
                            <li>Auto-pans and scales with optimal framing</li>
                            <li>Reveals next hierarchy level with animation</li>
                            <li>Parent marker fades out, children fade in</li>
                        </ul>
                        <p class="card-example">
                            <span class="example-label">Example:</span> Double-click "Asia" to see Japan, Singapore, and India
                        </p>
                    </div>
                </article>
                
                <!-- Multi-Selection -->
                <article class="interaction-card">
                    <div class="card-icon multi-select-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3>Multi-Selection</h3>
                        <ul>
                            <li><kbd>Ctrl</kbd> / <kbd>⌘ Cmd</kbd> + Click to add to selection</li>
                            <li>Works only within same hierarchy level</li>
                            <li>Cross-level selection clears previous selections</li>
                        </ul>
                    </div>
                </article>
                
                <!-- Zoom Controls -->
                <article class="interaction-card">
                    <div class="card-icon zoom-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            <line x1="11" y1="8" x2="11" y2="14"></line>
                            <line x1="8" y1="11" x2="14" y2="11"></line>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3>Zoom Controls</h3>
                        <ul>
                            <li><strong>+/- buttons:</strong> Zoom in/out with smooth animation</li>
                            <li><strong>Mouse wheel:</strong> Continuous zoom</li>
                            <li><strong>Click and drag:</strong> Pan the map</li>
                        </ul>
                    </div>
                </article>
            </div>
            
            <!-- Hierarchy Legend -->
            <div class="hierarchy-legend">
                <h3>Hierarchy Levels</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-marker continent"></span>
                        <span class="legend-label">Continents</span>
                    </div>
                    <div class="legend-arrow">→</div>
                    <div class="legend-item">
                        <span class="legend-marker country"></span>
                        <span class="legend-label">Countries</span>
                    </div>
                    <div class="legend-arrow">→</div>
                    <div class="legend-item">
                        <span class="legend-marker city"></span>
                        <span class="legend-label">Cities / Datacenters</span>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Scripts -->
    <script src="utils/dataProcessing.js"></script>
    <script src="utils/projection.js"></script>
    <script src="utils/selection.js"></script>
    <script src="geoMap.js"></script>
    <script src="test-utils.js"></script>
    <script>
        // Initialize the widget when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Load sample data
                const response = await fetch('data/sample-data.json');
                const geoLocationData = await response.json();
                
                // Initialize the widget
                const geoWidget = new GeoMapWidget({
                    container: '#geo-map-container',
                    data: geoLocationData,
                    width: null, // Auto-size to container
                    height: 600,
                    debug: true,
                    onMarkerClick: (location, isSelected) => {
                        console.log('Marker clicked:', location.label, 'Selected:', isSelected);
                    },
                    onMarkerDoubleClick: (location) => {
                        console.log('Zooming to:', location.label);
                    },
                    onSelectionChange: (selectedMarkers) => {
                        console.log('Selection changed:', selectedMarkers.map(m => m.label));
                        updateSelectionUI(selectedMarkers);
                    },
                    onZoomLevelChange: (level) => {
                        console.log('Zoom level changed:', level);
                    },
                    onFilterChange: (filters) => {
                        console.log('Filters changed:', filters);
                    },
                    maxSelections: 10
                });
                
                // Make widget globally accessible for debugging
                window.geoWidget = geoWidget;
                
                // Setup filter event listeners
                setupFilterListeners(geoWidget);
                
                // Setup clear selection button
                document.getElementById('clearSelection').addEventListener('click', () => {
                    geoWidget.clearSelection();
                });
                
            } catch (error) {
                console.error('Failed to initialize GeoMapWidget:', error);
                document.getElementById('geo-map-container').innerHTML = 
                    '<div class="error-message">Failed to load map data. Please try again.</div>';
            }
        });
        
        function updateSelectionUI(selectedMarkers) {
            const countEl = document.querySelector('.selection-count');
            const clearBtn = document.getElementById('clearSelection');
            
            countEl.textContent = `${selectedMarkers.length} selected`;
            clearBtn.style.display = selectedMarkers.length > 0 ? 'inline-block' : 'none';
        }
        
        function setupFilterListeners(widget) {
            const regionFilter = document.getElementById('regionFilter');
            const locationFilter = document.getElementById('locationFilter');
            const datacentreFilter = document.getElementById('datacentreFilter');
            
            regionFilter.addEventListener('change', () => {
                widget.applyFilters({
                    region: regionFilter.value,
                    location: locationFilter.value,
                    datacentre: datacentreFilter.value
                });
            });
            
            locationFilter.addEventListener('change', () => {
                widget.applyFilters({
                    region: regionFilter.value,
                    location: locationFilter.value,
                    datacentre: datacentreFilter.value
                });
            });
            
            datacentreFilter.addEventListener('change', () => {
                widget.applyFilters({
                    region: regionFilter.value,
                    location: locationFilter.value,
                    datacentre: datacentreFilter.value
                });
            });
        }
    </script>
</body>
</html>

